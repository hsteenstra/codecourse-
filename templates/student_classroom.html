{% extends "base.html" %}
{% block content %}

<section class="stage">
  <div class="kicker">CodeCourse • Student</div>
  <h1 style="margin-top: 14px;">Classroom</h1>
  <p class="subtitle">Stream updates and assignments from your classes.</p>
  <div class="chips">
    <div class="chip">Classes: <strong>{{ classrooms|length }}</strong></div>
    <div class="chip">Assignments: <strong>{{ assignments|length }}</strong></div>
  </div>
</section>

<div class="classroom-shell" style="margin-top: 18px;">
  <aside class="class-sidebar">
    <div class="panel">
      <div class="panel-title">Your classes</div>
      {% if classrooms %}
        <div class="class-list">
          <button class="class-tab active" type="button" data-classroom-id="all" data-classroom-name="All classes">
            <span>All classes</span>
            <small>See everything in one feed</small>
          </button>
          {% for c in classrooms %}
            <button class="class-tab" type="button" data-classroom-id="{{ c.id }}" data-classroom-name="{{ c.name }}">
              <span>{{ c.name }}</span>
              <small>Code: {{ c.code }}</small>
            </button>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted" style="margin-top: 8px;">You haven't joined a class yet.</p>
      {% endif %}
    </div>

    <div class="panel" style="margin-top: 16px;">
      <div class="panel-title">Join a class</div>
      <p class="muted" style="margin-top: 6px;">Enter the code your teacher gives you.</p>
      <form method="post" class="form" style="margin-top: 10px;">
        <input name="code" placeholder="Class code" required>
        <button class="btn btn-primary" type="submit">Join class</button>
      </form>
    </div>
  </aside>

  <section class="class-main">
    <div class="class-header-alt">
      <div>
        <h1 id="classroom-title">All classes</h1>
        <p class="subtitle" id="classroom-subtitle">Stream updates and open assignments from your classes.</p>
      </div>
      <div class="tabs-row" role="tablist" aria-label="Classroom sections">
        <button class="tab-btn active" type="button" data-tab="stream">Stream</button>
        <button class="tab-btn" type="button" data-tab="classwork">Classwork</button>
      </div>
    </div>

    <div id="tab-stream" class="stack">
      {% if stream_items %}
        {% for item in stream_items %}
          <div class="stream-item" data-classroom-id="{{ item.classroom_id }}">
            <div class="stream-title">{{ item.title }}</div>
            <div class="stream-body" style="white-space: pre-line;">{{ item.body }}</div>
            <div class="stream-meta">{{ item.classroom_name }} • {{ item.created_at|fmt_dt }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="panel">
          <h2>No stream posts yet</h2>
          <p class="subtitle">When your teacher posts assignments or grades, they’ll appear here.</p>
        </div>
      {% endif %}
    </div>

    <div id="tab-classwork" class="stack" style="display: none;">
      <div class="panel">
        <h2>Assignments</h2>
        {% if assignments %}
          <div class="stack" style="margin-top: 12px;">
            {% for a in assignments %}
              <div class="assignment-row" data-classroom-id="{{ a.classroom_id }}" style="flex-direction: column; align-items: stretch;">
                <div class="row between wrap">
                  <div>
                    <div class="strong">{{ a.lesson_lang|upper }} Lesson {{ a.lesson_id }}</div>
                    <div class="muted">{{ a.classroom_name }}</div>
                    {% if a.comment %}<div class="muted" style="margin-top: 4px;">Teacher note: {{ a.comment }}</div>{% endif %}
                    {% if a.due_date %}<div class="muted" style="margin-top: 4px;">Due: {{ a.due_date }}</div>{% endif %}
                  </div>

                  <div class="assignment-actions">
                    {% if a.status == 'completed' %}
                      <span class="pill-tag good">Completed</span>
                    {% else %}
                      <span class="pill-tag todo">To do</span>
                    {% endif %}
                    {% if a.grade_out_of_10 is not none %}
                      <span class="pill-tag grade">{{ a.grade_out_of_10 }}/10</span>
                    {% endif %}
                    <a class="btn btn-secondary" href="/student/lesson/{{ a.lesson_lang }}/{{ a.lesson_id }}">Open</a>
                  </div>
                </div>

                <div class="comment-shell" style="margin-top: 14px;">
                  <div class="panel-title">Comments</div>
                  {% set thread = comments_by_assignment.get(a.id, []) %}
                  {% if thread %}
                    <div class="comment-list" style="margin-top: 10px;">
                      {% for msg in thread %}
                        <div class="comment-item {{ 'teacher' if msg.author_role == 'teacher' else 'student' }}">
                          <div class="comment-role">{{ 'Teacher' if msg.author_role == 'teacher' else 'You' }}</div>
                          <div class="comment-body">{{ msg.body }}</div>
                          <div class="comment-meta">{{ msg.created_at|fmt_dt }}</div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="muted" style="margin-top: 8px;">No comments yet. Ask a question if you need help.</p>
                  {% endif %}

                  <form method="post" action="/student/assignment/{{ a.id }}/comment" class="form" style="margin-top: 10px; gap: 10px;">
                    <input name="comment" placeholder="Comment to your teacher" required>
                    <button class="btn btn-ghost" type="submit">Send</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="subtitle" style="margin-top: 8px;">No assignments yet.</p>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<script>
const tabButtons = document.querySelectorAll('[data-tab]');
const stream = document.getElementById('tab-stream');
const classwork = document.getElementById('tab-classwork');

tabButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const which = btn.dataset.tab;
    stream.style.display = which === 'stream' ? 'grid' : 'none';
    classwork.style.display = which === 'classwork' ? 'grid' : 'none';
  });
});

const classTabs = Array.from(document.querySelectorAll('.class-tab[data-classroom-id]'));
const titleEl = document.getElementById('classroom-title');
const subtitleEl = document.getElementById('classroom-subtitle');
const streamItems = Array.from(document.querySelectorAll('.stream-item[data-classroom-id]'));
const assignmentItems = Array.from(document.querySelectorAll('.assignment-row[data-classroom-id]'));

function setActiveClassTab(tab) {
  classTabs.forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  const id = tab.dataset.classroomId;
  const name = tab.dataset.classroomName;

  if (titleEl) titleEl.textContent = name || 'Classroom';
  if (subtitleEl) subtitleEl.textContent = id === 'all' ? 'Stream updates and open assignments from your classes.' : 'Focused view of this class.';

  const showAll = id === 'all';
  streamItems.forEach(el => el.style.display = (showAll || el.dataset.classroomId === id) ? '' : 'none');
  assignmentItems.forEach(el => el.style.display = (showAll || el.dataset.classroomId === id) ? '' : 'none');
}

classTabs.forEach(tab => tab.addEventListener('click', () => setActiveClassTab(tab)));
</script>

{% endblock %}
