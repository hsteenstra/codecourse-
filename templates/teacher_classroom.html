{% extends "base.html" %}
{% block content %}

<section class="stage">
  <div class="row between baseline wrap">
    <div>
      <div class="kicker">CodeCourse • Teacher</div>
      <h1 style="margin-top: 14px;">{{ classroom.name }}</h1>
      <p class="subtitle">Class code: <strong>{{ classroom.code }}</strong></p>
    </div>

    <div class="row wrap">
      <div class="chip">Students: <strong>{{ students|length }}</strong></div>
      <div class="chip">Assignments: <strong>{{ assignments|length }}</strong></div>
      <form method="post" action="/teacher/classroom/{{ classroom.id }}/delete" onsubmit="return confirm('Delete this classroom? This cannot be undone.');">
        <button class="btn btn-danger" type="submit">Delete class</button>
      </form>
    </div>
  </div>
</section>

<div class="classroom-shell" style="margin-top: 18px;">
  <aside class="class-sidebar">
    <div class="panel">
      <div class="panel-title">Your classes</div>
      <div class="class-list">
        {% for c in classrooms %}
          <a class="class-tab {{ 'active' if c.id == classroom.id else '' }}" href="/teacher/classroom/{{ c.id }}">
            <span>{{ c.name }}</span>
            <small>Code: {{ c.code }}</small>
          </a>
        {% endfor %}
      </div>
      <div style="margin-top: 12px;">
        <a class="btn btn-primary" href="/teacher/classroom/create">Create classroom</a>
      </div>
    </div>
  </aside>

  <section class="class-main">
    <div class="class-header-alt">
      <div>
        <h2>Classroom</h2>
        <p class="subtitle">Stream, classwork, people, and grading — all in one place.</p>
      </div>
      <div class="tabs-row" role="tablist" aria-label="Classroom sections">
        <button class="tab-btn active" type="button" data-tab="stream">Stream</button>
        <button class="tab-btn" type="button" data-tab="classwork">Classwork</button>
        <button class="tab-btn" type="button" data-tab="people">People</button>
        <button class="tab-btn" type="button" data-tab="grades">Grades</button>
      </div>
    </div>

    <div id="tab-stream" class="stack">
      <div class="panel">
        <h2>Post an announcement</h2>
        <form method="post" action="/teacher/classroom/{{ classroom.id }}/announce" class="form" style="margin-top: 10px;">
          <textarea name="message" rows="3" placeholder="Share an update with your class..." required></textarea>
          <button class="btn btn-primary" type="submit">Post</button>
        </form>
      </div>

      {% if stream_items %}
        {% for item in stream_items %}
          <div class="stream-item">
            <div class="stream-title">{{ item.title }}</div>
            <div class="stream-body" style="white-space: pre-line;">{{ item.body }}</div>
            <div class="stream-meta">{{ item.author_name }} • {{ item.created_at|fmt_dt }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div class="panel">
          <h2>No posts yet</h2>
          <p class="subtitle">Announcements and assignments will show up here.</p>
        </div>
      {% endif %}
    </div>

    <div id="tab-classwork" class="stack" style="display:none;">
      <div class="panel">
        <h2>Create an assignment</h2>
        <form method="post" action="/teacher/classroom/{{ classroom.id }}/assignments/create" class="form" style="margin-top: 10px;">
          <label>Lesson</label>
          <select name="lesson_key" required>
            <option disabled selected>Select a lesson</option>
            {% for lang in languages %}
              {% if lang.enabled %}
                {% for lesson in lang.lessons %}
                  <option value="{{ lang.id }}:{{ lesson.id }}">{{ lang.name }} • {{ lesson.title }}</option>
                {% endfor %}
              {% endif %}
            {% endfor %}
          </select>
          <div class="form-row">
            <div class="span-6">
              <label>Due date (optional)</label>
              <input type="date" name="due_date">
            </div>
            <div class="span-6">
              <label>Note (optional)</label>
              <input name="comment" placeholder="Add a note for students">
            </div>
          </div>
          <button class="btn btn-primary" type="submit">Post assignment</button>
        </form>
      </div>

      <div class="panel">
        <h2>Assignments</h2>
        {% if assignments %}
          <div class="stack" style="margin-top: 10px;">
            {% for a in assignments %}
              <div class="assignment-row" style="flex-direction: column; align-items: stretch;">
                <div class="row between wrap">
                  <div>
                    <div class="strong">{{ a.lesson_lang|upper }} Lesson {{ a.lesson_id }}</div>
                    {% if a.comment %}<div class="muted" style="margin-top: 4px;">Note: {{ a.comment }}</div>{% endif %}
                    {% if a.due_date %}<div class="muted" style="margin-top: 4px;">Due: {{ a.due_date }}</div>{% endif %}
                  </div>
                  <div class="assignment-actions">
                    <span class="pill-tag">{{ a.completed_count or 0 }}/{{ a.total_subs or 0 }} completed</span>
                  </div>
                </div>

                {% set threads = comments_by_assignment.get(a.id, {}) %}
                {% if threads %}
                  <div class="comment-shell" style="margin-top: 14px;">
                    <div class="panel-title">Comments</div>
                    <div class="stack" style="margin-top: 10px;">
                      {% for t in threads.values() %}
                        <div class="comment-thread">
                          <div class="comment-title">{{ t.name }} (@{{ t.username }})</div>
                          <div class="comment-list">
                            {% for msg in t.thread %}
                              <div class="comment-item {{ 'teacher' if msg.author_role == 'teacher' else 'student' }}">
                                <div class="comment-role">{{ 'Teacher' if msg.author_role == 'teacher' else 'Student' }}</div>
                                <div class="comment-body">{{ msg.body }}</div>
                                <div class="comment-meta">{{ msg.created_at|fmt_dt }}</div>
                              </div>
                            {% endfor %}
                          </div>
                          <form method="post" action="/teacher/assignment/{{ a.id }}/comment" class="form" style="margin-top: 10px;">
                            <input type="hidden" name="student_id" value="{{ t.student_id }}">
                            <input name="message" placeholder="Reply to {{ t.name }}" required>
                            <button class="btn btn-secondary" type="submit">Reply</button>
                          </form>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="subtitle" style="margin-top: 8px;">No assignments posted yet.</p>
        {% endif %}
      </div>

      <div class="panel">
        <h2>Invite by email</h2>
        <p class="subtitle">Keep a list of invited emails. Students can still join with the class code.</p>
        <form method="post" action="/teacher/classroom/{{ classroom.id }}/invite" class="form" style="margin-top: 10px;">
          <input type="email" name="email" placeholder="Student email" required>
          <button class="btn btn-secondary" type="submit">Save invite</button>
        </form>
        {% if invites %}
          <div class="stack" style="margin-top: 10px;">
            {% for invite in invites %}
              <div class="stream-item">
                <div class="stream-title">{{ invite.email }}</div>
                <div class="stream-body">Invited: {{ invite.invited_at|fmt_dt }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div id="tab-people" class="stack" style="display:none;">
      <div class="panel">
        <h2>Students</h2>
        {% if students %}
          <div class="stack" style="margin-top: 10px;">
            {% for s in students %}
              <div class="assignment-row">
                <div>
                  <div class="strong">{{ s.name }}</div>
                  <div class="muted">@{{ s.username }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="subtitle" style="margin-top: 8px;">No students have joined yet.</p>
        {% endif %}
      </div>
    </div>

    <div id="tab-grades" class="stack" style="display:none;">
      <div class="panel">
        <h2>Grades</h2>
        <p class="subtitle">Enter grades out of 10. Students will see updates immediately.</p>

        {% if submissions %}
          <div class="stack" style="margin-top: 10px;">
            {% for s in submissions %}
              <div class="assignment-row">
                <div>
                  <div class="strong">{{ s.name }} (@{{ s.username }})</div>
                  <div class="muted">{{ s.lesson_lang|upper }} Lesson {{ s.lesson_id }} • Status: {{ s.status }}</div>
                  {% if s.score is not none %}<div class="muted" style="margin-top: 4px;">Quiz score: {{ s.score }}%</div>{% endif %}
                </div>
                <div class="assignment-actions">
                  <form method="post" action="/teacher/submission/{{ s.submission_id }}/grade" class="row" style="gap: 10px;">
                    <input name="grade" type="number" min="0" max="10" placeholder="/10" value="{{ s.grade_out_of_10 or '' }}" style="width: 90px;">
                    <button class="btn btn-secondary" type="submit">Save</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="subtitle" style="margin-top: 8px;">No submissions yet.</p>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<script>
const tabButtons = document.querySelectorAll('[data-tab]');
const sections = {
  stream: document.getElementById('tab-stream'),
  classwork: document.getElementById('tab-classwork'),
  people: document.getElementById('tab-people'),
  grades: document.getElementById('tab-grades'),
};

tabButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const which = btn.dataset.tab;
    Object.entries(sections).forEach(([k, el]) => {
      el.style.display = (k === which) ? 'grid' : 'none';
    });
  });
});
</script>

{% endblock %}
